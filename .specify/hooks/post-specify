#!/bin/bash
# Post-specify hook: Runs after spec file is written and completed
# Arguments: $1 = feature description
# Environment: BRANCH_NAME, SPEC_FILE, FEATURE_NUM available

# 1. Commit and push the spec file
git add "$SPEC_FILE"
git commit -m "Complete spec $FEATURE_NUM: $1"
git push -u origin "$BRANCH_NAME"

# 2. Link branch to GitHub issue and update status
if command -v gh >/dev/null 2>&1; then
    # Get the issue number from feature number (they match)
    ISSUE_NUM="$FEATURE_NUM"

    # Link the branch to the issue (Development section)
    gh issue develop "$ISSUE_NUM" --branch "$BRANCH_NAME" || true

    # Update issue with completion details
    gh issue comment "$ISSUE_NUM" --body "âœ… Specification completed!

- **Branch:** [\`$BRANCH_NAME\`](https://github.com/\$(gh repo view --json nameWithOwner -q .nameWithOwner)/tree/$BRANCH_NAME)
- **Spec File:** [\`$SPEC_FILE\`](https://github.com/\$(gh repo view --json nameWithOwner -q .nameWithOwner)/blob/$BRANCH_NAME/$SPEC_FILE)
- **Status:** Ready for review"

    # Add labels to indicate spec is complete
    gh issue edit "$ISSUE_NUM" --add-label "spec-complete"
fi

# Example: Send completion notification
# echo "Specification $FEATURE_NUM completed: $SPEC_FILE" | mail -s "Spec Ready for Review" team@company.com

# Example: Trigger CI/CD pipeline
# curl -X POST "$CI_WEBHOOK_URL" -d '{"event":"spec_completed","branch":"'$BRANCH_NAME'","spec":"'$SPEC_FILE'"}'

# Default: Do nothing
exit 0